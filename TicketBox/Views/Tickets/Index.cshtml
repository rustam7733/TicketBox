@model List<TicketBox.Models.Ticket>
@using Microsoft.AspNetCore.Identity
@using TicketBox.Models
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager

@{
    ViewData["Title"] = "Билеты";

    var grouped = Model
        .GroupBy(t => t.Session)
        .OrderByDescending(g => g.Key.StartTime);

    var now = DateTime.Now;

    var actualSessions = grouped.Where(g => g.Key.StartTime > now);
    var pastSessions = grouped.Where(g => g.Key.StartTime <= now);

    int sessionIndex = 0;
}

<h2 class="mb-4">Билеты</h2>

<form class="row mb-4" method="get">
    <div class="col-md-6">
        <input type="text" name="searchCode" value="@ViewBag.SearchCode" class="form-control" placeholder="Поиск по коду билета..." />
    </div>
    <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Поиск</button>
    </div>
    <div class="col-md-2">
        <a href="@Url.Action("Index")" class="btn btn-outline-secondary w-100">Сброс</a>
    </div>
</form>

<div class="accordion mb-5" id="accordionActual">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingActual">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseActual" aria-expanded="true" aria-controls="collapseActual">
                🎬 Актуальные сеансы
            </button>
        </h2>
        <div id="collapseActual" class="accordion-collapse collapse show" aria-labelledby="headingActual" data-bs-parent="#accordionActual">
            <div class="accordion-body">
                @if (!actualSessions.Any())
                {
                    <p>Нет актуальных сеансов.</p>
                }
                else
                {
                    foreach (var sessionGroup in actualSessions)
                    {
                        <div class="card mb-3 shadow-sm">
                            <div class="card-header bg-success text-white">
                                <strong>@sessionGroup.Key.Movie.Title</strong> —
                                Зал: @sessionGroup.Key.Hall.Name |
                                Начало: @sessionGroup.Key.StartTime.ToString("g")
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-sm table-striped m-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Код</th>
                                            <th>Ряд</th>
                                            <th>Место</th>
                                            <th>Статус</th>
                                            <th class="text-end">Отмена</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var ticket in sessionGroup)
                                        {
                                            <tr>
                                                <td>@ticket.Code</td>
                                                <td>@ticket.Row</td>
                                                <td>@ticket.Number</td>
                                                <td>@ticket.Status</td>
                                                <td class="text-end">
                                                    @if (ticket.Status == TicketStatus.Reserved)
                                                    {
                                                        <form asp-action="CancelReservation" method="post" class="d-inline">
                                                            <input type="hidden" name="ticketId" value="@ticket.Id" />
                                                            <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('Отменить бронь?')">Отменить бронь</button>
                                                        </form>
                                                    }
                                                    else if (ticket.Status == TicketStatus.Sold)
                                                    {
                                                        <form asp-action="CancelPurchase" method="post" class="d-inline">
                                                            <input type="hidden" name="ticketId" value="@ticket.Id" />
                                                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Отменить покупку?')">Отменить покупку</button>
                                                        </form>
                                                    }
                                                </td>

                                            </tr>
                                        }
                                    </tbody>
                                </table>
                                <div class="px-3 py-2 bg-light border-top text-end">
                                    @if (SignInManager.IsSignedIn(@User) && User.IsInRole("admin"))
                                    {
                                        <strong>Сумма проданных билетов:</strong>
                                        var total = sessionGroup
                                        .Where(t => t.Status == TicketStatus.Sold)
                                        .Sum(t => t.Session.Price);
                                        <p>@total.ToString() сум</p>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

<div class="accordion" id="accordionPast">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingPast">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePast" aria-expanded="false" aria-controls="collapsePast">
                📽️ Завершённые сеансы
            </button>
        </h2>
        <div id="collapsePast" class="accordion-collapse collapse" aria-labelledby="headingPast" data-bs-parent="#accordionPast">
            <div class="accordion-body">
                @if (!pastSessions.Any())
                {
                    <p>Нет завершённых сеансов.</p>
                }
                else
                {
                    foreach (var sessionGroup in pastSessions)
                    {
                        <div class="card mb-3 shadow-sm">
                            <div class="card-header bg-secondary text-white">
                                <strong>@sessionGroup.Key.Movie.Title</strong> —
                                Зал: @sessionGroup.Key.Hall.Name |
                                Начало: @sessionGroup.Key.StartTime.ToString("g")
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-sm table-striped m-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Код</th>
                                            <th>Ряд</th>
                                            <th>Место</th>
                                            <th>Статус</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var ticket in sessionGroup)
                                        {
                                            <tr>
                                                <td>@ticket.Code</td>
                                                <td>@ticket.Row</td>
                                                <td>@ticket.Number</td>
                                                <td>@ticket.Status</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                                <div class="px-3 py-2 bg-light border-top text-end">
                                    @if (SignInManager.IsSignedIn(@User) && User.IsInRole("admin"))
                                    {
                                        <strong>Сумма проданных билетов:</strong>
                                        var total = sessionGroup
                                        .Where(t => t.Status == TicketStatus.Sold)
                                        .Sum(t => t.Session.Price);
                                        <p>@total.ToString() сум</p>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>
